{% block simple_visualizer %}
<style>

.node {
  cursor: pointer;
  color: #d62728;
}

.edge {
  fill: none;
  stroke: #ff9896;
  stroke-width: 2px;
}

#backgroundRect{
    stroke: #e7ba52;
    stroke-width: 3;
    fill: #e7ba52;
    opacity: 0.1;
}

</style>
<script>
    function onNodeClick(element){
        console.log(element);
      // alert("ID: "+ element.textContent);
    }
</script>

<script>

    var graphNodes = {{ nodes | safe }}
    var graphEdges = {{ edges | safe }}

    var nodesLookup = graphNodes.reduce(function(accumulator, node) {
        accumulator[node.node_id] = node;
        return accumulator;
    }, {});

    var forceSimulation = d3.forceSimulation(graphNodes)
        .force('link', d3.forceLink(graphEdges).id(function(d) { return d.node_id; }).distance(200))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(1000 / 2, 1000 / 2))
        .on('tick', onTick);

    var dragHandler = d3.drag()
        .on('start', onDragStart)
        .on('drag', onDragged)
        .on('end', onDragEnd);

    var zoomHandler = d3.zoom()
        .scaleExtent([0.2, 10])
        .on('zoom', onZoomed);

    var svgCanvas = d3.select('#visualization')
        .attr('width', 1000)
        .attr('height', 1000)
        .call(zoomHandler);

    var graphContainer = svgCanvas.append('g');

    var backgroundRect = graphContainer.append("rect")
        .attr("id","backgroundRect")
        .attr("width", 1400)
        .attr("height", 1000)

    var edgeElements = graphContainer.selectAll('.edge')
        .data(graphEdges)
        .enter().append('line')
        .attr('class', 'edge');

    var nodeElements = graphContainer.selectAll('.node')
        .data(graphNodes)
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d) { return d.name; })
        .call(dragHandler);

    nodeElements.append('circle')
        .attr('r', 30)
        .attr('fill', '#ff9896');

    nodeElements.append('text')
        .attr('text-anchor', 'middle')
        .attr('alignment-baseline', 'central')
        .attr('fill', '#d62728')
        .text(function(d) { return d.node_id; });

    function onTick(e) {
        nodeElements.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";});

        edgeElements.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });
    }

    function onZoomed() {
        graphContainer.attr("transform", d3.event.transform);

        const transform = d3.event.transform;

        const scaleX = transform.k;
        const scaleY = transform.k;
        const translateX = transform.x;
        const translateY = transform.y;

        const rectWidth = 1400 / scaleX;
        const rectHeight = 1000 / scaleY;

        const rectX = -translateX / scaleX;
        const rectY = -translateY / scaleY;

        backgroundRect.attr("x", rectX)
            .attr("y", rectY)
            .attr("width", rectWidth)
            .attr("height", rectHeight)
    }

    function onDragStart(d) {
        if (!d3.event.active) forceSimulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function onDragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function onDragEnd(d) {
        if (!d3.event.active) forceSimulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

</script>
{% endblock %}
